name: CI/CD - Vercel

on:
    push:
        branches:
            - master
    pull_request:
        branches:
            - master

permissions:
    contents: read

jobs:
    quality:
        name: Lint and Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Lint
              run: npm run lint -- .

            - name: Build
              run: npm run build

    deploy_preview:
        name: Deploy Preview to Vercel (PR)
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        needs: quality
        env:
            VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
            VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
            VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Pull Vercel Environment (preview)
              run: npx vercel pull --yes --environment=preview --token=${{ env.VERCEL_TOKEN }}

            - name: Build with Vercel (preview)
              run: npx vercel build --token=${{ env.VERCEL_TOKEN }}

            - name: Deploy to Vercel (preview)
              id: deploy
              run: |
                  preview_url=$(npx vercel deploy --prebuilt --token=${{ env.VERCEL_TOKEN }})
                  echo "preview_url=$preview_url" >> $GITHUB_OUTPUT

            - name: Output preview URL
              run: echo Preview URL ${{ steps.deploy.outputs.preview_url }}

    deploy_production:
        name: Deploy Production to Vercel (master)
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        runs-on: ubuntu-latest
        needs: quality
        env:
            VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
            VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
            VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Pull Vercel Environment (production)
              run: npx vercel pull --yes --environment=production --token=${{ env.VERCEL_TOKEN }}

            - name: Build with Vercel (production)
              run: npx vercel build --token=${{ env.VERCEL_TOKEN }}

            - name: Deploy to Vercel (production)
              id: deploy
              run: |
                  production_url=$(npx vercel deploy --prebuilt --prod --token=${{ env.VERCEL_TOKEN }})
                  echo "production_url=$production_url" >> $GITHUB_OUTPUT

            - name: Output production URL
              run: echo Production URL ${{ steps.deploy.outputs.production_url }}
